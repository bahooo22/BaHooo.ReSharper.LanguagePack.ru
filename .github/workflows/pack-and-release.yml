name: Сборка RU ReSharper I18n

on:
  push:
    branches: [main]
  workflow_dispatch:
  
permissions:
  contents: write
  
jobs:
  pack:
    runs-on: windows-latest

    steps:
      - name: Проверка кода
        uses: actions/checkout@v4

      - name: Read nuspec version and check release
        id: check
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $nuspecPath = "NugetFolder/BaHooo.ReSharper.I18n.ru/BaHooo.ReSharper.I18n.ru.nuspec"
          $xml = Get-Content $nuspecPath -Raw
          $match = [Regex]::Match($xml, '<version>(.*?)</version>', 'IgnoreCase')
          if (-not $match.Success) { throw "Version not found in nuspec" }
          $currentVersion = $match.Groups[1].Value
          Write-Host "Found version: $currentVersion"
      
          $latest = gh release list --limit 1 --json tagName --jq '.[0].tagName'
          Write-Host "Latest release tag: $latest"
      
          # Проверяем не пустые ли значения
          if ([string]::IsNullOrEmpty($currentVersion)) {
            Write-Host "ОШИБКА: currentVersion пустая!"
            exit 1
          }
      
          if ([string]::IsNullOrEmpty($latest)) {
            Write-Host "Нет существующих релизов, создаем новый"
            "skip=false" >> $env:GITHUB_OUTPUT
            "version=$currentVersion" >> $env:GITHUB_OUTPUT
          } elseif ($currentVersion -eq $latest) {
            Write-Host "Версии совпадают, пропускаем сборку"
            "skip=true" >> $env:GITHUB_OUTPUT
            "version=$currentVersion" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Версии отличаются, продолжаем сборку"
            "skip=false" >> $env:GITHUB_OUTPUT
            "version=$currentVersion" >> $env:GITHUB_OUTPUT
          }


      - name: Конвертация RESX в ресурсы
        if: steps.check.outputs.skip == 'false'
        shell: pwsh
        run: |
          pwsh .\resx-to-resources.ps1 `
            -ResxFolder ".\raw-resx-done_ru-RU" `
            -ResourcesOutput ".\build\resources" `
            -LogFile "build.log" `
            -ErrorLogFile "build.errors.log"

      - name: Сборка NuGet пакета
        if: steps.check.outputs.skip == 'false'
        shell: pwsh
        run: pwsh .\NugetFolder\BaHooo.ReSharper.I18n.ru\build.ps1 -Output ".\NugetFolder\artifacts"

      - name: Сборка JetBrains Marketplace пакета
        if: steps.check.outputs.skip == 'false'
        shell: pwsh
        run: pwsh .\MarketplaceFolder\BaHooo.ReSharper.I18n.ru\build.ps1 -Output ".\MarketplaceFolder\artifacts"
            
      - name: Создание релиза если его нет
        if: steps.check.outputs.skip == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          gh release view "${{ steps.check.outputs.version }}" --repo "${{ github.repository }}" || `
            gh release create "${{ steps.check.outputs.version }}" `
              --repo "${{ github.repository }}" `
              --title "${{ steps.check.outputs.version }}" `
              --notes "Автоматически созданный релиз для версии ${{ steps.check.outputs.version }}"

      - name: Переименовать NuGet пакет
        if: steps.check.outputs.skip == 'false'
        shell: pwsh
        run: |
          $file = Get-ChildItem NugetFolder/artifacts/*.nupkg | Select-Object -First 1
          Rename-Item $file.FullName ("NugetFolder/artifacts/BaHooo.ReSharper.I18n.ru.${{ steps.check.outputs.version }}.nuget.nupkg")

      - name: Переименовать Marketplace пакет
        if: steps.check.outputs.skip == 'false'
        shell: pwsh
        run: |
          $file = Get-ChildItem MarketplaceFolder/artifacts/*.nupkg | Select-Object -First 1
          Rename-Item $file.FullName ("MarketplaceFolder/artifacts/BaHooo.ReSharper.I18n.ru.${{ steps.check.outputs.version }}.marketplace.nupkg")

      - name: Загрузка NuGet пакета в релиз
        if: steps.check.outputs.skip == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          gh release upload "${{ steps.check.outputs.version }}" `
            NugetFolder/artifacts/*.nuget.nupkg `
            --repo "${{ github.repository }}"

      - name: Загрузка JetBrains пакета в релиз
        if: steps.check.outputs.skip == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          gh release upload "${{ steps.check.outputs.version }}" `
            MarketplaceFolder/artifacts/*.marketplace.nupkg `
            --repo "${{ github.repository }}"
