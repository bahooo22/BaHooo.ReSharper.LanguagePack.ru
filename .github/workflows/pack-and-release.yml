name: Сборка RU ReSharper I18n

on:
  push:
    branches: [main]
  workflow_dispatch:
  
jobs:
  pack:
    runs-on: windows-latest

    steps:
      - name: Проверка кода
        uses: actions/checkout@v4

      - name: Чтение версии из nuspec
        id: nuspec
        shell: pwsh
        run: |
          $nuspecPath = "NugetFolder/BaHooo.ReSharper.I18n.ru/BaHooo.ReSharper.I18n.ru.nuspec"
          $xml = Get-Content $nuspecPath -Raw
          $match = [Regex]::Match($xml, '<version>(.*?)</version>', 'IgnoreCase')
          if (-not $match.Success) { throw "Версия не найдена в nuspec" }
          $version = $match.Groups[1].Value
          Write-Host "Найдена версия: $version"
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Проверка изменения версии
        id: check
        shell: pwsh
        run: |
          # Получаем версию из предыдущего шага
          $currentVersion = "${{ steps.nuspec.outputs.version }}"
          Write-Host "Текущая версия: '$currentVersion'"
          
          # Получаем последний релиз
          $latest = gh release list --limit 1 --json tagName --jq '.[0].tagName'
          Write-Host "Последний тег релиза: '$latest'"
          
          # Проверяем не пустые ли значения
          if ([string]::IsNullOrEmpty($currentVersion)) {
            Write-Host "ОШИБКА: currentVersion пустая!"
            exit 1
          }
          
          if ([string]::IsNullOrEmpty($latest)) {
            Write-Host "Нет существующих релизов, создаем новый"
            "skip=false" >> $env:GITHUB_OUTPUT
          } elseif ($currentVersion -eq $latest) {
            Write-Host "Версии совпадают, пропускаем сборку"
            "skip=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Версии отличаются, продолжаем сборку"
            "skip=false" >> $env:GITHUB_OUTPUT
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Конвертация RESX в ресурсы
        if: steps.check.outputs.skip == 'false'
        shell: pwsh
        run: |
          pwsh .\resx-to-resources.ps1 `
            -ResxFolder ".\raw-resx-done_ru-RU" `
            -ResourcesOutput ".\build\resources" `
            -LogFile "build.log" `
            -ErrorLogFile "build.errors.log"

      - name: Сборка NuGet пакета
        if: steps.check.outputs.skip == 'false'
        shell: pwsh
        run: pwsh .\NugetFolder\BaHooo.ReSharper.I18n.ru\build.ps1 -Output ".\NugetFolder\artifacts"

      - name: Сборка JetBrains Marketplace пакета
        if: steps.check.outputs.skip == 'false'
        shell: pwsh
        run: pwsh .\MarketplaceFolder\BaHooo.ReSharper.I18n.ru\build.ps1 -Output ".\MarketplaceFolder\artifacts"
            
      - name: Создание релиза если его нет
        if: steps.check.outputs.skip == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          gh release view "${{ steps.nuspec.outputs.version }}" --repo "${{ github.repository }}" || `
            gh release create "${{ steps.nuspec.outputs.version }}" `
              --repo "${{ github.repository }}" `
              --title "${{ steps.nuspec.outputs.version }}" `
              --notes "Автоматически созданный релиз для версии ${{ steps.nuspec.outputs.version }}"

      - name: Загрузка NuGet пакета в релиз
        if: steps.check.outputs.skip == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          gh release upload "${{ steps.nuspec.outputs.version }}" `
            NugetFolder/artifacts/*.nupkg `
            --repo "${{ github.repository }}"

      - name: Загрузка JetBrains пакета в релиз
        if: steps.check.outputs.skip == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          gh release upload "${{ steps.nuspec.outputs.version }}" `
            MarketplaceFolder/artifacts/*.nupkg `
            --repo "${{ github.repository }}"