name: Publish to JetBrains Marketplace

on:
  release:
    types: [created]
  workflow_dispatch: {}

jobs:
  jetbrains:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é
          fetch-tags: true # –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –≤—Å–µ —Ç–µ–≥–∏

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1

      - name: Pack JetBrains Extension
        run: nuget pack JetBrainsMarketplaceFolder/JetBrains.I18n.ru/BaHooo.JetBrains.I18n.ru.nuspec -OutputDirectory JetBrainsMarketplaceFolder/out

      - name: Publish to JetBrains Marketplace
        run: |
          $pkg = Get-ChildItem JetBrainsMarketplaceFolder/out/BaHooo.JetBrains.I18n.ru.*.nupkg | Select-Object -First 1
          nuget push $pkg.FullName -Source https://plugins.jetbrains.com/ -ApiKey ${{ secrets.JETBRAINS_MARKETPLACE_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: JetBrains.I18n.ru.nupkg
          path: JetBrainsMarketplaceFolder/out/*.nupkg

      - name: Log release info
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ–≥ (–Ω—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π fetch –∏ —Ç–µ–≥–∏)
          $prevTag = git describe --tags --abbrev=0
          # –¢–µ–∫—É—â–∏–π —Ç–µ–≥ –±–µ—Ä—ë–º –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
          $currTag = $env:GITHUB_REF -replace 'refs/tags/', ''
          # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ GitHub summary
          Add-Content $env:GITHUB_STEP_SUMMARY "## üì¶ JetBrains Marketplace package published: $currTag"
          Add-Content $env:GITHUB_STEP_SUMMARY "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$prevTag...$currTag"
