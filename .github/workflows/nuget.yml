name: Publish NuGet Package

on:
  release:
    types: [created]
  workflow_dispatch: {}

jobs:
  nuget:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1

      - name: Pack NuGet
        run: nuget pack NugetFolder/JetBrains.I18n.ru/BaHooo.ReSharper.I18n.ru.nuspec -OutputDirectory NugetFolder/out

      - name: Publish to NuGet
        if: github.event_name == 'release'
        run: |
          # –ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
          cd $env:GITHUB_WORKSPACE
          
          # –ù–∞–π—Ç–∏ –≤—Å–µ .nupkg —Ñ–∞–π–ª—ã
          $packages = Get-ChildItem -Path "NugetFolder/out" -Filter "*.nupkg"
          
          if ($packages.Count -eq 0) {
            Write-Host "No .nupkg files found in NugetFolder/out/"
            Write-Host "Current directory: $(Get-Location)"
            Write-Host "Listing NugetFolder/out/:"
            Get-ChildItem -Path "NugetFolder/out" -Recurse
            exit 1
          }
          
          Write-Host "Found package(s):"
          $packages | ForEach-Object { Write-Host "  - $($_.Name)" }
          
          # –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π –ø–∞–∫–µ—Ç
          $packagePath = $packages[0].FullName
          Write-Host "Publishing: $packagePath"
          nuget push "$packagePath" -Source https://api.nuget.org/v3/index.json -ApiKey ${{ secrets.NUGET_API_KEY }} -SkipDuplicate

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BaHooo.ReSharper.I18n.ru.nupkg
          path: NugetFolder/out/*.nupkg

      - name: Log release info
        run: |
          $prevTag = git describe --tags --abbrev=0
          $currTag = $env:GITHUB_REF -replace 'refs/tags/', ''
          Add-Content $env:GITHUB_STEP_SUMMARY "## üì¶ NuGet package published: $currTag"
          Add-Content $env:GITHUB_STEP_SUMMARY "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$prevTag...$currTag"