name: Publish NuGet Package

on:
  release:
    types: [created]
  workflow_dispatch: {}

jobs:
  nuget:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1

      - name: Pack NuGet
        run: nuget pack NugetFolder/JetBrains.I18n.ru/BaHooo.ReSharper.I18n.ru.nuspec -OutputDirectory NugetFolder/out

      - name: Debug - List files
        run: |
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Files in NugetFolder/out/:"
          Get-ChildItem -Path NugetFolder/out -Recurse -ErrorAction Continue | Format-Table -AutoSize

      - name: Publish to NuGet
        if: github.event_name == 'release'
        run: |
          $packagePath = Join-Path $env:GITHUB_WORKSPACE "NugetFolder/out"
          Write-Host "Looking for packages in: $packagePath"
          
          $packages = Get-ChildItem -Path $packagePath -Filter *.nupkg
          if ($packages.Count -eq 0) {
            Write-Host "No .nupkg files found!"
            exit 1
          }
          
          Write-Host "Found packages:"
          $packages | ForEach-Object { Write-Host "  - $($_.FullName)" }
          
          $firstPackage = $packages[0].FullName
          Write-Host "Publishing: $firstPackage"
          nuget push "$firstPackage" -Source https://api.nuget.org/v3/index.json -ApiKey ${{ secrets.NUGET_API_KEY }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BaHooo.ReSharper.I18n.ru.nupkg
          path: NugetFolder/out/*.nupkg

      - name: Log release info
        run: |
          $prevTag = git describe --tags --abbrev=0
          $currTag = $env:GITHUB_REF -replace 'refs/tags/', ''
          Add-Content $env:GITHUB_STEP_SUMMARY "## ðŸ“¦ NuGet package published: $currTag"
          Add-Content $env:GITHUB_STEP_SUMMARY "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$prevTag...$currTag"